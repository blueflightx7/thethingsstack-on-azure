<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800">
  <defs>
    <style>
      .vnet { fill: #E3F2FD; stroke: #1976D2; stroke-width: 3; }
      .subnet { fill: #FFF9C4; stroke: #F57F17; stroke-width: 2; stroke-dasharray: 5,5; }
      .vm-box { fill: #0078D4; stroke: #004578; stroke-width: 2; }
      .db-box { fill: #00B4E6; stroke: #007BA7; stroke-width: 2; }
      .kv-box { fill: #50E6FF; stroke: #00B4E6; stroke-width: 2; }
      .nsg-box { fill: #F25022; stroke: #A62300; stroke-width: 2; }
      .internet { fill: #E0E0E0; stroke: #757575; stroke-width: 2; }
      .text-white { fill: white; font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; font-weight: 600; }
      .text-black { fill: #333; font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; }
      .text-small { fill: white; font-family: 'Segoe UI', Arial, sans-serif; font-size: 10px; }
      .title { fill: #333; font-family: 'Segoe UI', Arial, sans-serif; font-size: 22px; font-weight: 700; }
      .subtitle { fill: #666; font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; font-style: italic; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-red { stroke: #D32F2F; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); }
      .arrow-green { stroke: #388E3C; stroke-width: 2; fill: none; marker-end: url(#arrowhead-green); }
      .label { fill: #333; font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; }
      .port-label { fill: #666; font-family: 'Courier New', monospace; font-size: 10px; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#D32F2F" />
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#388E3C" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="35" class="title" text-anchor="middle">VM Deployment Network Architecture</text>
  <text x="600" y="55" class="subtitle" text-anchor="middle">The Things Stack on Azure - Production Security</text>
  
  <!-- Internet -->
  <rect x="50" y="90" width="150" height="80" rx="5" class="internet"/>
  <text x="125" y="120" class="text-black" text-anchor="middle" font-weight="700">Internet</text>
  <text x="125" y="138" class="text-black" text-anchor="middle" font-size="11">LoRaWAN Gateways</text>
  <text x="125" y="153" class="text-black" text-anchor="middle" font-size="11">End Users</text>
  
  <!-- VNet Container -->
  <rect x="250" y="90" width="900" height="650" rx="10" class="vnet"/>
  <text x="260" y="115" class="text-black" font-weight="700">Virtual Network (10.0.0.0/16)</text>
  
  <!-- VM Subnet -->
  <rect x="280" y="140" width="400" height="280" rx="5" class="subnet"/>
  <text x="290" y="165" class="text-black" font-weight="600">VM Subnet (10.0.1.0/24)</text>
  
  <!-- NSG -->
  <rect x="300" y="190" width="140" height="70" rx="5" class="nsg-box"/>
  <text x="370" y="215" class="text-white" text-anchor="middle">Network Security</text>
  <text x="370" y="230" class="text-white" text-anchor="middle">Group (NSG)</text>
  <text x="370" y="250" class="text-small" text-anchor="middle">SSH: Restricted IP</text>
  
  <!-- VM -->
  <rect x="480" y="180" width="180" height="220" rx="5" class="vm-box"/>
  <text x="570" y="205" class="text-white" text-anchor="middle">Virtual Machine</text>
  <text x="570" y="222" class="text-white" text-anchor="middle">Ubuntu 22.04 LTS</text>
  
  <line x1="490" y1="232" x2="650" y2="232" stroke="white" stroke-width="1"/>
  
  <text x="570" y="252" class="text-small" text-anchor="middle">Docker Engine</text>
  <text x="570" y="270" class="text-small" text-anchor="middle">├─ TTS Container</text>
  <text x="570" y="285" class="text-small" text-anchor="middle">├─ Redis Container</text>
  <text x="570" y="300" class="text-small" text-anchor="middle">└─ Watchtower</text>
  
  <line x1="490" y1="310" x2="650" y2="310" stroke="white" stroke-width="1"/>
  
  <text x="570" y="330" class="text-small" text-anchor="middle">Ports:</text>
  <text x="570" y="345" class="text-small" text-anchor="middle">443 (HTTPS), 80 (HTTP)</text>
  <text x="570" y="360" class="text-small" text-anchor="middle">1700 (UDP), 1881-1887</text>
  <text x="570" y="375" class="text-small" text-anchor="middle">22 (SSH - Restricted)</text>
  
  <text x="570" y="395" class="text-small" text-anchor="middle" font-weight="700">Managed Identity</text>
  
  <!-- Database Subnet -->
  <rect x="720" y="140" width="400" height="280" rx="5" class="subnet"/>
  <text x="730" y="165" class="text-black" font-weight="600">Database Subnet (10.0.2.0/24)</text>
  <text x="730" y="180" class="text-black" font-size="10" font-style="italic">Delegated to Microsoft.DBforPostgreSQL/flexibleServers</text>
  
  <!-- PostgreSQL -->
  <rect x="750" y="220" width="340" height="120" rx="5" class="db-box"/>
  <text x="920" y="245" class="text-white" text-anchor="middle">PostgreSQL Flexible Server</text>
  <text x="920" y="260" class="text-white" text-anchor="middle">Zone-Redundant</text>
  
  <line x1="760" y1="270" x2="1080" y2="270" stroke="white" stroke-width="1"/>
  
  <text x="920" y="290" class="text-small" text-anchor="middle">Private Endpoint Only</text>
  <text x="920" y="305" class="text-small" text-anchor="middle">TLS 1.2 Required</text>
  <text x="920" y="320" class="text-small" text-anchor="middle">Private IP: 10.0.2.x</text>
  <text x="920" y="335" class="text-small" text-anchor="middle">Port: 5432</text>
  
  <!-- Key Vault -->
  <rect x="280" y="460" width="360" height="120" rx="5" class="kv-box"/>
  <text x="460" y="490" class="text-white" text-anchor="middle" font-size="15">Azure Key Vault</text>
  
  <line x1="290" y1="500" x2="630" y2="500" stroke="white" stroke-width="1"/>
  
  <text x="460" y="520" class="text-small" text-anchor="middle">Secrets Stored:</text>
  <text x="360" y="540" class="text-small">• DB Password</text>
  <text x="360" y="555" class="text-small">• TTS Admin Credentials</text>
  <text x="520" y="540" class="text-small">• Cookie Keys</text>
  <text x="520" y="555" class="text-small">• OAuth Client Secret</text>
  <text x="360" y="570" class="text-small">RBAC: Key Vault Secrets Officer</text>
  
  <!-- Private DNS Zone -->
  <rect x="720" y="460" width="400" height="120" rx="5" fill="#FFF3E0" stroke="#E65100" stroke-width="2"/>
  <text x="920" y="490" class="text-black" text-anchor="middle" font-weight="600">Private DNS Zone</text>
  <text x="920" y="508" class="text-black" text-anchor="middle" font-size="11">privatelink.postgres.database.azure.com</text>
  
  <line x1="730" y1="518" x2="1110" y2="518" stroke="#E65100" stroke-width="1"/>
  
  <text x="920" y="540" class="text-black" text-anchor="middle" font-size="11">Linked to VNet</text>
  <text x="920" y="560" class="text-black" text-anchor="middle" font-size="10" font-style="italic">Resolves PostgreSQL FQDN to private IP</text>
  
  <!-- Arrows and Labels -->
  
  <!-- Internet to NSG -->
  <path d="M 200 130 L 300 215" class="arrow-red"/>
  <text x="220" y="160" class="label">HTTPS (443)</text>
  <text x="220" y="175" class="label">UDP (1700)</text>
  
  <!-- Internet to NSG (blocked) -->
  <path d="M 200 145 L 300 235" stroke="#D32F2F" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
  <text x="220" y="195" class="label" fill="#D32F2F">SSH Blocked</text>
  
  <!-- NSG to VM -->
  <path d="M 440 230 L 480 290" class="arrow-green"/>
  <text x="445" y="255" class="label" fill="#388E3C">Allowed Traffic</text>
  
  <!-- VM to Database -->
  <path d="M 660 290 L 750 280" class="arrow-green"/>
  <text x="670" y="275" class="label" fill="#388E3C">Private Connection</text>
  <text x="670" y="288" class="port-label">postgresql://.../?sslmode=require</text>
  
  <!-- VM to Key Vault -->
  <path d="M 570 400 L 460 460" class="arrow-green"/>
  <text x="490" y="425" class="label" fill="#388E3C">Managed Identity</text>
  <text x="490" y="438" class="label">Secrets Access</text>
  
  <!-- DNS Zone to Database -->
  <path d="M 920 460 L 920 340" class="arrow" stroke-dasharray="3,3"/>
  <text x="930" y="395" class="label">DNS Resolution</text>
  <text x="930" y="408" class="label">Private IP Lookup</text>
  
  <!-- Legend -->
  <rect x="280" y="620" width="840" height="100" rx="5" fill="#F9F9F9" stroke="#CCC" stroke-width="1"/>
  <text x="290" y="640" class="text-black" font-weight="700">Security Features</text>
  
  <text x="300" y="660" class="text-black" font-size="11">✅ SSH restricted to deployer IP only</text>
  <text x="300" y="678" class="text-black" font-size="11">✅ Database has NO public endpoint</text>
  <text x="300" y="696" class="text-black" font-size="11">✅ All secrets in Key Vault with RBAC</text>
  
  <text x="640" y="660" class="text-black" font-size="11">✅ TLS 1.2 enforced for database</text>
  <text x="640" y="678" class="text-black" font-size="11">✅ Let's Encrypt auto-renewal via cron</text>
  <text x="640" y="696" class="text-black" font-size="11">✅ VM uses Azure DNS (168.63.129.16)</text>
  
  <text x="300" y="713" class="text-black" font-size="10" font-style="italic">⚠️ Critical: Private DNS zone must be linked to VNet for brownfield deployments</text>
</svg>
